<template>
<div>

    <!-- Шаги -->
    <div class="steps">
        <p
            class="mr-2"
            :class="{ active: step == 1 }"
            @click="moveToStep(1)"
        >
            <b>1. Загрузить видео ></b>
        </p>
        <p :class="{ active: step == 2 }" @click="moveToStep(2)">
            <b>2. Редактировать видео</b>
        </p>
    </div>

    <!-- first step -->
    <div v-if="step == 1">
        <upload-files
            :token="token"
            type="video"
            :id="playlist_id"
            :file_types="['mp4', 'flv']"
            @onupload="onupload"
        />

        <div class="uploaded_files" v-if="file !== null">
            <p>
                <b>Загружено {{ Number(file.size / 1024 / 1024).toFixed(3) }}mb</b>
            </p>
            <p>{{ file.name }}</p>
        </div>
    </div>

    <!-- second step -->
    <div v-if="step == 2">
        <div class="row mb-2" v-if="file !== null">
            <div class="col-md-4">
                Название
            </div>
            <div class="col-md-8">
                <input
                    type="text"
                    class="form-control"
                    v-model="file.model.title"
                />
            </div>

            <div class="col-md-12">
                <p>
                    <b>Загружено {{ Number(file.size / 1024 / 1024).toFixed(3) }}mb</b>
                </p>
                <p>{{ file.name }}</p>
            </div>
        </div>
        <div class="d-flex mt-3">
            <button class="btn mr-1" @click="saveVideo">Сохранить</button>
            <button class="btn" @click="deleteVideo">Удалить</button>
        </div>
    </div>

</div>
</template>

<script>
export default {
    name: 'VideoUploader',
    props: {
        token: String,
        playlist_id: Number,
        group_id: Number
    },
    data(){
        return {
          step: 1,
          file: null,
          video: {
            title: "",
            links: "",
            text: "",
          },
        }
    },

    created() {
      
    },

    methods: {
        onupload(item) {
            console.log("onupload");
            console.log(item);
            this.file = item;
            this.step = 2;
        },

        moveToStep(i) {
            if (i == 2 && this.file === null) return;
            this.step = i;
        },

        deleteVideo() {
            axios
                .post("/playlists/delete-video", {
                    id: this.file.model.id,
                })
                .then((response) => {
                    this.$toast.success("Файл удален");
                    this.file = null;
                    this.step = 1;
                })
                .catch((error) => {
                    alert(error);
                });
        },

        saveVideo() {
            let loader = this.$loading.show();
            axios
                .post("/playlists/save-video", {
                    id: this.playlist_id,
                    video: this.file.model,
                    group_id: this.group_id
                })
                .then((response) => {   
                    loader.hide()
                    this.step = 1;
                    this.$emit('addVideoToPlaylist', response.data.video) 
                    this.$toast.success("Добавлен");
                    this.file = null;

                    this.$emit('close');
                })
                .catch((error) => {
                    loader.hide()
                    alert(error);
                });
        },
    
    }
}
</script>